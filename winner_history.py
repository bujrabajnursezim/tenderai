import re

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ó–ê–•–ê–†–î–ö–û–ñ–ï–ù–ù–´–ï –î–ï–ú–û-–î–ê–ù–ù–´–ï
# –í —Ä–µ–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ ‚Äî –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ goszakup API
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

WINNER_DATABASE = {
    "–¢–û–û –¢–µ—Ö–Ω–æ–ü–∞—Ä–∫ –ê—Å—Ç–∞–Ω–∞": {
        "wins": [
            {"tender": "–ó–∞–∫—É–ø–∫–∞ –Ω–æ—É—Ç–±—É–∫–æ–≤ Dell XPS", "amount": "12,750,000 —Ç–≥", "customer": "–ì–£ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –¢—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏", "year": 2022},
            {"tender": "–ó–∞–∫—É–ø–∫–∞ —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è", "amount": "8,400,000 —Ç–≥", "customer": "–ì–£ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –¢—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏", "year": 2023},
            {"tender": "–ó–∞–∫—É–ø–∫–∞ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤ –∏ –ú–§–£", "amount": "3,200,000 —Ç–≥", "customer": "–ì–£ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –¢—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏", "year": 2023},
            {"tender": "–ó–∞–∫—É–ø–∫–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–π —Ç–µ—Ö–Ω–∏–∫–∏", "amount": "15,600,000 —Ç–≥", "customer": "–ì–£ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –¢—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏", "year": 2024},
            {"tender": "–ó–∞–∫—É–ø–∫–∞ –Ω–æ—É—Ç–±—É–∫–æ–≤ –¥–ª—è –∫–ª–∞—Å—Å–æ–≤", "amount": "12,750,000 —Ç–≥", "customer": "–ì–£ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –¢—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏", "year": 2024},
        ],
        "risk": "high"
    },
    "–¢–û–û –î–µ–ª—å—Ç–∞–°–µ—Ä–≤–∏—Å": {
        "wins": [
            {"tender": "–†–µ–º–æ–Ω—Ç –æ—Ä–≥—Ç–µ—Ö–Ω–∏–∫–∏", "amount": "1,200,000 —Ç–≥", "customer": "–ê–∫–∏–º–∞—Ç –¢—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏", "year": 2023},
            {"tender": "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ", "amount": "980,000 —Ç–≥", "customer": "–ê–∫–∏–º–∞—Ç –¢—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏", "year": 2024},
        ],
        "risk": "medium"
    },
    "–¢–û–û –ê–ª–º–∞—Ç—ã–¢—Ä–µ–π–¥": {
        "wins": [
            {"tender": "–ü–æ—Å—Ç–∞–≤–∫–∞ –∫–∞–Ω—Ü—Ç–æ–≤–∞—Ä–æ–≤", "amount": "450,000 —Ç–≥", "customer": "–®–∫–æ–ª–∞ ‚Ññ5 –≥. –¢—É—Ä–∫–µ—Å—Ç–∞–Ω", "year": 2024},
        ],
        "risk": "low"
    },
}

# –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞
SUPPLIER_KEYWORDS = [
    r"(–¢–û–û\s+[\w\s]{3,30})",
    r"—Å–µ—Ä–≤–∏—Å–Ω\w+\s+—Ü–µ–Ω—Ç—Ä[^\n\.]{0,30}",
    r"—á–µ—Ä–µ–∑\s+(–¢–û–û\s+[\w\s]{3,20})",
]


def check_winner_history(text):
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –ø–æ–±–µ–¥ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ —É–ø–æ–º—è–Ω—É—Ç–æ–≥–æ –≤ —Ç–µ–Ω–¥–µ—Ä–µ.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å —Å –∏—Å—Ç–æ—Ä–∏–µ–π –∏ —É—Ä–æ–≤–Ω–µ–º —Ä–∏—Å–∫–∞.
    """
    # –ò—â–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –≤ —Ç–µ–∫—Å—Ç–µ
    detected_supplier = None
    for pattern in SUPPLIER_KEYWORDS:
        match = re.search(pattern, text, re.IGNORECASE)
        if match:
            found = match.group(0).strip()
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –≤ –±–∞–∑–µ
            for supplier_name in WINNER_DATABASE:
                if any(word.lower() in found.lower() for word in supplier_name.split()):
                    detected_supplier = supplier_name
                    break
        if detected_supplier:
            break

    # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –¥–µ–º–æ
    if not detected_supplier:
        # –î–ª—è –¥–µ–º–æ ‚Äî –µ—Å–ª–∏ —Ç–µ–Ω–¥–µ—Ä –≤—ã—Å–æ–∫–æ–≥–æ —Ä–∏—Å–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¢–µ—Ö–Ω–æ–ü–∞—Ä–∫
        if re.search(r"(Dell|—Å—Ç—Ä–æ–≥–æ|–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω\w+\s+–¥–∏–ª–µ—Ä)", text, re.IGNORECASE):
            detected_supplier = "–¢–û–û –¢–µ—Ö–Ω–æ–ü–∞—Ä–∫ –ê—Å—Ç–∞–Ω–∞"

    if not detected_supplier:
        return {
            "found": False,
            "message": "–ü–æ—Å—Ç–∞–≤—â–∏–∫ –≤ —Ç–µ–∫—Å—Ç–µ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω",
            "supplier": None,
            "wins": [],
            "risk_level": "unknown"
        }

    data = WINNER_DATABASE[detected_supplier]
    wins = data["wins"]
    risk = data["risk"]
    same_customer_wins = [w for w in wins if w["customer"] == wins[0]["customer"]]

    if risk == "high":
        flag = "üî¥"
        message = f"–ü–æ—Å—Ç–∞–≤—â–∏–∫ –ø–æ–±–µ–∂–¥–∞–ª —É –æ–¥–Ω–æ–≥–æ –∑–∞–∫–∞–∑—á–∏–∫–∞ {len(same_customer_wins)} —Ä–∞–∑ –ø–æ–¥—Ä—è–¥ ‚Äî –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–≥–æ–≤–æ—Ä"
    elif risk == "medium":
        flag = "üü°"
        message = f"–ü–æ—Å—Ç–∞–≤—â–∏–∫ –∏–º–µ–µ—Ç {len(wins)} –ø–æ–±–µ–¥—ã ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞"
    else:
        flag = "üü¢"
        message = f"–ü–æ—Å—Ç–∞–≤—â–∏–∫ –∏–º–µ–µ—Ç {len(wins)} –ø–æ–±–µ–¥—É ‚Äî –∏—Å—Ç–æ—Ä–∏—è —á–∏—Å—Ç–∞—è"

    return {
        "found": True,
        "supplier": detected_supplier,
        "flag": flag,
        "message": message,
        "wins": wins,
        "total_wins": len(wins),
        "same_customer_wins": len(same_customer_wins),
        "risk_level": risk,
        "demo_note": "‚ö†Ô∏è –î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ. –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ ‚Äî —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ goszakup.gov.kz"
    }
